name: ğŸš€ Build & Deploy to Production

on:
  push:
    branches: [main]

# ========================================
# ğŸ”§ é¡¹ç›®é…ç½®å˜é‡ï¼ˆå¤ç”¨åˆ°å…¶ä»–é¡¹ç›®æ—¶åªéœ€ä¿®æ”¹è¿™é‡Œï¼‰
# ========================================
env:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: pwa-home # é¡¹ç›®åç§°ï¼ˆç”¨äºèµ„æºå‘½åï¼‰
  GITHUB_REPO: ray-sOrg/pwa-home # GitHub ä»“åº“åœ°å€

  # è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR é…ç½®
  TCR_REGISTRY: ccr.ccs.tencentyun.com # TCR è®¿é—®åŸŸå
  TCR_NAMESPACE: ray321 # TCR å‘½åç©ºé—´

  # Kubernetes é…ç½®
  K8S_NAMESPACE: default # K8s å‘½åç©ºé—´
  K8S_DEPLOYMENT_FILE: deployment.yaml # K8s éƒ¨ç½²æ–‡ä»¶å

  # å¥åº·æ£€æŸ¥é…ç½®
  HEALTH_CHECK_PATH: / # å¥åº·æ£€æŸ¥è·¯å¾„
  CONTAINER_PORT: 3000 # å®¹å™¨ç«¯å£

  # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  ROLLOUT_TIMEOUT: 180

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ› ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 0

      # è®¾ç½® Docker Buildx (æ”¯æŒé«˜çº§ç¼“å­˜)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR
      - name: Login to Tencent Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TCR_REGISTRY }}
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾ï¼ˆæ„å»ºå· + commit çŸ­ç ï¼‰
      - name: Generate image metadata
        id: meta
        run: |
          # é•œåƒåœ°å€
          IMAGE_NAME=${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ env.PROJECT_NAME }}

          # é•œåƒæ ‡ç­¾ï¼šbuild-æ„å»ºå·-commitçŸ­ç 
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          # è¾“å‡ºç»™åç»­æ­¥éª¤
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¤ æ¨é€åœ°å€: $IMAGE_NAME:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒ (ä½¿ç”¨ BuildKit ç¼“å­˜)
      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜ (å…è´¹ã€å¿«é€Ÿ)
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # åªæ„å»º amd64 é¿å…å¤šæ¶æ„æµªè´¹æ—¶é—´
          platforms: linux/amd64

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      # æ‹‰å–ä»“åº“ä»£ç  (éœ€è¦ deployment.yaml)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 0

      # å®‰è£… kubectl (é˜²æ­¢ Runner ç¯å¢ƒç¼ºå¤±)
      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            echo "kubectl not found, installing..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/
          else
            echo "kubectl is already installed"
          fi

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿å…¶åœ¨åç»­æ‰€æœ‰æ­¥éª¤ä¸­ç”Ÿæ•ˆ
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

          # æ˜¾ç¤ºé›†ç¾¤ API åœ°å€
          echo "ğŸ“ é›†ç¾¤ API åœ°å€ï¼š"
          kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
          echo ""

          # éªŒè¯é›†ç¾¤è¿æ¥
          echo "ğŸ” éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info --request-timeout=10s
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åˆ›å»ºè…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯
      - name: Create Tencent TCR Pull Secret
        run: |
          # åˆ é™¤æ—§çš„ secretï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          kubectl delete secret tencent-tcr-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true

          # åˆ›å»ºæ–°çš„ docker-registry secret
          kubectl create secret docker-registry tencent-tcr-secret \
            --docker-server=${{ env.TCR_REGISTRY }} \
            --docker-username="${{ secrets.TCR_USERNAME }}" \
            --docker-password="${{ secrets.TCR_PASSWORD }}" \
            --namespace=${{ env.K8S_NAMESPACE }}

          echo "âœ… è…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" ${{ env.K8S_DEPLOYMENT_FILE }}
          sed -i "s|__IMAGE_TAG__|$TAG|g" ${{ env.K8S_DEPLOYMENT_FILE }}

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f ${{ env.K8S_DEPLOYMENT_FILE }}

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€å¹¶è‡ªåŠ¨å›æ»šï¼ˆé˜²æ­¢åç‰ˆæœ¬ï¼‰
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=${{ env.PROJECT_NAME }}-deployment
          set -e
          if kubectl rollout status deployment/$DEPLOY_NAME --timeout=${{ env.ROLLOUT_TIMEOUT }}s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Notify Deployment Result
        if: always()
        run: |
          STATUS=${{ job.status }}
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}
          echo "ğŸ“¢ éƒ¨ç½²çŠ¶æ€: $STATUS"
          echo "ğŸ“¦ é•œåƒ: $IMAGE:$TAG"
